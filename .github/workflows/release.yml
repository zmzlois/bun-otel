name: Automated Release

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: "Release type"
        required: true
        type: choice
        options:
          - auto
          - patch
          - minor
          - major
        default: "auto"
      dry_run:
        description: "Dry run (no actual release)"
        required: false
        type: boolean
        default: false

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for changelog
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: bun install

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Build package
        run: bun run build
        working-directory: ./package/bun-otel

      - name: Run tests
        run: bun test
        working-directory: ./package/bun-otel

      - name: Preview release
        id: preview
        run: |
          cd package/bun-otel

          echo "Current version: $(node -p "require('./package.json').version")"
          echo "Analyzing commits for version bump..."

          # Preview what changelogen would do
          if [ "${{ inputs.release_type }}" = "auto" ]; then
            npx changelogen@latest --bump --no-commit --no-tag
          else
            npx changelogen@latest --${{ inputs.release_type }} --no-commit --no-tag
          fi

          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version will be: $NEW_VERSION"

          # Restore package.json for actual release
          git checkout package.json

      - name: Generate changelog preview
        run: |
          echo "## üìù Changelog Preview"
          npx changelogen@latest

      - name: Create release
        if: ${{ !inputs.dry_run }}
        run: |
          cd package/bun-otel

          echo "Creating release..."

          # Use changelogen to bump version, update changelog, commit, and tag
          if [ "${{ inputs.release_type }}" = "auto" ]; then
            npx changelogen@latest --release --push
          else
            npx changelogen@latest --release --${{ inputs.release_type }} --push
          fi

          echo "‚úÖ Release created and pushed!"

      - name: Dry run summary
        if: ${{ inputs.dry_run }}
        run: |
          echo "üîç DRY RUN - No changes were made"
          echo "Version would be bumped to: ${{ steps.preview.outputs.new_version }}"
          echo "To create the release, run this workflow again with 'Dry run' unchecked"

      - name: Release summary
        if: ${{ !inputs.dry_run }}
        run: |
          echo "üöÄ Release v${{ steps.preview.outputs.new_version }} created!"
          echo "The publish workflow will now automatically:"
          echo "  1. Build the package"
          echo "  2. Publish to npm with provenance"
          echo "  3. Create GitHub release with changelog"
          echo ""
          echo "Monitor the publish workflow in the Actions tab"
